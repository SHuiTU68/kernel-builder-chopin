name: Manual ReSukiSU Build (Final Success)

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: '内核源码地址'
        required: true
        default: 'https://github.com/ChopinKernels/kernel_xiaomi_chopin_android_S'
      repo_branch:
        description: '分支名 (如 master)'
        required: true
        default: 'master'
      enable_kpm:
        description: '开启 KPM (KernelSU)'
        type: boolean
        default: true
      enable_susfs:
        description: '注入 SUSFS 补丁'
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 第一步：不再使用 checkout 自己的仓库，直接创建一个全新的目录
      - name: 准备构建环境
        run: |
          mkdir -p workspace
          cd workspace
          # 在这个绝对干净的目录下克隆工具
          git clone --depth=1 https://github.com/ReSukiSU/ReSukiSU.git .
          # 赋予所有脚本执行权限
          chmod +x *.sh

      - name: 执行编译与打包
        run: |
          # 进入刚才创建的目录运行
          cd workspace
          ./build.sh
        env:
          KERNEL_REPO: ${{ inputs.repo_url }}
          KERNEL_BRANCH: ${{ inputs.repo_branch }}
          KERNEL_DEVICE: chopin
          KERNEL_DEFCONFIG: chopin_defconfig
          
          # 核心开关：这里会通过 ReSukiSU 脚本远程下载 SUSFS 补丁并 patch 进源码
          ENABLE_KERNELSU: ${{ inputs.enable_kpm }}
          ENABLE_KERNELSU_SFS: ${{ inputs.enable_susfs }}
          
          # 自动下载编译器
          CLANG_URL: https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz
          
          USE_ANYKERNEL3: true
          ENABLE_CCACHE: true
          CONFIRM_RELEASE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
