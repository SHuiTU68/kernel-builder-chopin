name: 手动构建内核 (rKSU + SUSFS)

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: '内核源码仓库 (格式: owner/repo，例如 xiaomi-mt6893-dev/kernel_xiaomi_mt6893)'
        required: true
        default: 'xiaomi-mt6893-dev/kernel_xiaomi_mt6893'
      kernel_branch:
        description: '内核源码分支 (留空则自动使用默认分支)'
        required: false
        default: ''
      enable_susfs:
        description: '启用 SUSFS 功能'
        type: boolean
        default: false
      rksu_commit:
        description: 'rKSU 的 commit 哈希值'
        required: true
        default: '46b695633ebce2fd87d811e45e14789725ee041ecd690cb2b1a1caf962f12ed4'

jobs:
  build-kernel:
    name: 编译内核 (rKSU + SUSFS)
    runs-on: ubuntu-22.04
    steps:
      - name: 检出工作流仓库
        uses: actions/checkout@v4

      - name: 格式化仓库地址
        id: format_repo
        run: |
          RAW_REPO="${{ github.event.inputs.kernel_repo }}"
          if [[ "$RAW_REPO" =~ ^https?://github.com/([^/]+/[^/]+)(\.git)?$ ]]; then
            CLEAN_REPO="${BASH_REMATCH[1]}"
          elif [[ "$RAW_REPO" =~ ^[^/]+/[^/]+$ ]]; then
            CLEAN_REPO="$RAW_REPO"
          else
            echo "❌ 无法识别的仓库格式: $RAW_REPO"
            exit 1
          fi
          echo "clean_repo=$CLEAN_REPO" >> $GITHUB_OUTPUT
          echo "使用仓库: $CLEAN_REPO"

      # ===== 智能克隆内核源码 =====
      - name: 克隆内核源码（自动处理分支）
        id: clone_kernel
        run: |
          REPO="${{ steps.format_repo.outputs.clean_repo }}"
          CLONE_URL="https://github.com/${REPO}.git"
          USER_BRANCH="${{ github.event.inputs.kernel_branch }}"
          
          if [ -n "$USER_BRANCH" ]; then
            echo "尝试克隆用户指定的分支: $USER_BRANCH"
            for i in {1..3}; do
              echo "尝试 $i/3..."
              if git clone --depth=1 --branch "$USER_BRANCH" "$CLONE_URL" kernel_xiaomi_chopin; then
                echo "成功克隆分支 $USER_BRANCH"
                exit 0
              fi
              sleep 5
            done
            echo "警告：无法克隆指定分支 $USER_BRANCH，将尝试克隆默认分支"
          fi
          
          echo "尝试克隆默认分支"
          for i in {1..3}; do
            echo "尝试 $i/3..."
            if git clone --depth=1 "$CLONE_URL" kernel_xiaomi_chopin; then
              cd kernel_xiaomi_chopin
              DEFAULT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
              echo "成功克隆默认分支: $DEFAULT_BRANCH"
              cd ..
              exit 0
            fi
            sleep 5
          done
          
          echo "❌ 所有克隆尝试均失败，请检查仓库地址"
          exit 1

      # ===== 安装依赖包（包含 Clang 和交叉 GCC）=====
      - name: 安装依赖包
        run: |
          sudo apt update
          sudo apt install -y git ccache automake flex lzop bison \
            gperf build-essential zip curl zlib1g-dev zlib1g-dev:native \
            python3 python3-pip libxml2-utils bzip2 libbz2-dev \
            libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush \
            schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev \
            pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl \
            libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev \
            libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            clang-14 lld-14 llvm-14

      # 验证工具版本（可选）
      - name: 验证工具链
        run: |
          clang-14 --version
          aarch64-linux-gnu-gcc --version
          ld.lld-14 --version

      # ===== rKSU 集成 =====
      - name: 克隆 rKSU 仓库并检出指定 commit
        run: |
          git clone https://github.com/rsuntk/KernelSU.git rksu_src
          cd rksu_src
          git checkout ${{ github.event.inputs.rksu_commit }}
          echo "已检出 commit: $(git rev-parse HEAD)"
        working-directory: ${{ runner.temp }}

      - name: 手动集成 rKSU 驱动到内核源码
        run: |
          cd kernel_xiaomi_chopin
          mkdir -p KernelSU
          cp -r ${{ runner.temp }}/rksu_src/kernel/* KernelSU/
          
          if ! grep -q "source \"KernelSU/Kconfig\"" Kconfig; then
            echo "" >> Kconfig
            echo "source \"KernelSU/Kconfig\"" >> Kconfig
          fi
          
          if ! grep -q "obj-y += KernelSU/" Makefile; then
            echo "" >> Makefile
            echo "obj-y += KernelSU/" >> Makefile
          fi
          
          echo "rKSU 驱动已集成 (commit: ${{ github.event.inputs.rksu_commit }})"

      # ===== SUSFS 集成（可选）=====
      - name: 集成 SUSFS 4.14 补丁
        if: ${{ github.event.inputs.enable_susfs == 'true' }}
        run: |
          cd kernel_xiaomi_chopin
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.14
          
          cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
          cp susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch ./
          cp -r susfs4ksu/kernel_patches/fs/* fs/
          cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/
          
          cd KernelSU && patch -p1 < 10_enable_susfs_for_ksu.patch
          cd .. && patch -p1 < 50_add_susfs_in_kernel-4.14.patch
          
          echo "SUSFS 补丁应用完成"

      # ===== 内核配置 =====
      - name: 配置内核
        run: |
          cd kernel_xiaomi_chopin
          # 请根据实际内核修改 defconfig 文件名，此处给出智能查找示例
          if [ -f arch/arm64/configs/chopin_defconfig ]; then
            make ARCH=arm64 chopin_defconfig
          elif [ -f arch/arm64/configs/vendor/chopin_defconfig ]; then
            make ARCH=arm64 vendor/chopin_defconfig
          else
            # 尝试自动查找第一个 defconfig
            DEFCONFIG=$(find arch/arm64/configs -name "*defconfig" | head -n1)
            if [ -n "$DEFCONFIG" ]; then
              echo "使用找到的配置文件: $DEFCONFIG"
              make ARCH=arm64 $(basename $DEFCONFIG)
            else
              echo "❌ 未找到任何 defconfig，请手动指定"
              exit 1
            fi
          fi

          # 启用 rKSU 必需配置
          scripts/config --enable CONFIG_KSU_MANUAL_HOOK
          scripts/config --disable CONFIG_KSU_SYSCALL_HOOK
          scripts/config --enable CONFIG_KSU_MULTI_MANAGER_SUPPORT

          # 启用 SUSFS 配置（如果启用）
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            scripts/config --enable CONFIG_KSU_SUSFS
            scripts/config --enable CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_SU
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_KSTAT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_BINDER
          fi

          # 保存配置
          make savedefconfig
          cp defconfig arch/arm64/configs/custom_defconfig

      # ===== 编译内核 =====
      - name: 编译内核
        run: |
          cd kernel_xiaomi_chopin
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CC=clang-14
          export LD=ld.lld-14
          # 使用 LLVM=1 让内核构建系统尽可能使用 LLVM 工具
          make -j$(nproc) O=out ARCH=arm64 CC=clang-14 LD=ld.lld-14 LLVM=1 2>&1 | tee build.log

          # 复制内核镜像
          if [ -f out/arch/arm64/boot/Image.gz-dtb ]; then
            cp out/arch/arm64/boot/Image.gz-dtb ../Image.gz-dtb
          elif [ -f out/arch/arm64/boot/Image.gz ]; then
            cp out/arch/arm64/boot/Image.gz ../Image.gz
          else
            echo "未找到内核镜像文件"
            exit 1
          fi

      # ===== 打包 AnyKernel3 =====
      - name: 准备 AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git -b master AnyKernel3
        working-directory: ${{ runner.temp }}

      - name: 创建刷机包
        run: |
          cp Image.gz-dtb ${{ runner.temp }}/AnyKernel3/ 2>/dev/null || cp Image.gz ${{ runner.temp }}/AnyKernel3/
          
          cd ${{ runner.temp }}/AnyKernel3
          echo "Kernel with rKSU" > README
          echo "Build date: $(date)" >> README
          echo "rKSU commit: ${{ github.event.inputs.rksu_commit }}" >> README
          echo "SUSFS: ${{ github.event.inputs.enable_susfs }}" >> README
          
          zip -r9 kernel-$(date +%Y%m%d-%H%M).zip * -x .git README.md *placeholder
          mv kernel-*.zip $GITHUB_WORKSPACE/

      - name: 上传内核刷机包
        uses: actions/upload-artifact@v4
        with:
          name: kernel-rksu-susfs
          path: ./*.zip
          if-no-files-found: error