name: 手动构建内核 (rKSU + SUSFS)

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: '内核源码仓库 (格式: owner/repo，例如 xiaomi-mt6893-dev/kernel_xiaomi_mt6893)'
        required: true
        default: 'xiaomi-mt6893-dev/kernel_xiaomi_mt6893'
      kernel_branch:
        description: '内核源码分支 (留空则自动使用默认分支)'
        required: false
        default: ''
      enable_susfs:
        description: '启用 SUSFS 功能'
        type: boolean
        default: false
      rksu_commit:
        description: 'rKSU 的 commit 哈希值'
        required: true
        default: '46b695633ebce2fd87d811e45e14789725ee041ecd690cb2b1a1caf962f12ed4'

jobs:
  build-kernel:
    name: 编译内核 (rKSU + SUSFS)
    runs-on: ubuntu-22.04
    steps:
      - name: 检出工作流仓库
        uses: actions/checkout@v4

      - name: 格式化仓库地址
        id: format_repo
        run: |
          RAW_REPO="${{ github.event.inputs.kernel_repo }}"
          if [[ "$RAW_REPO" =~ ^https?://github.com/([^/]+/[^/]+)(\.git)?$ ]]; then
            CLEAN_REPO="${BASH_REMATCH[1]}"
          elif [[ "$RAW_REPO" =~ ^[^/]+/[^/]+$ ]]; then
            CLEAN_REPO="$RAW_REPO"
          else
            echo "❌ 无法识别的仓库格式: $RAW_REPO"
            exit 1
          fi
          echo "clean_repo=$CLEAN_REPO" >> $GITHUB_OUTPUT
          echo "使用仓库: $CLEAN_REPO"

      # ===== 改进的克隆步骤 =====
      - name: 克隆内核源码（自动处理分支）
        id: clone_kernel
        run: |
          REPO="${{ steps.format_repo.outputs.clean_repo }}"
          CLONE_URL="https://github.com/${REPO}.git"
          USER_BRANCH="${{ github.event.inputs.kernel_branch }}"
          
          if [ -n "$USER_BRANCH" ]; then
            echo "尝试克隆用户指定的分支: $USER_BRANCH"
            for i in {1..3}; do
              echo "尝试 $i/3..."
              if git clone --depth=1 --branch "$USER_BRANCH" "$CLONE_URL" kernel_xiaomi_chopin; then
                echo "成功克隆分支 $USER_BRANCH"
                exit 0
              fi
              sleep 5
            done
            echo "警告：无法克隆指定分支 $USER_BRANCH，将尝试克隆默认分支"
          fi
          
          echo "尝试克隆默认分支"
          for i in {1..3}; do
            echo "尝试 $i/3..."
            if git clone --depth=1 "$CLONE_URL" kernel_xiaomi_chopin; then
              cd kernel_xiaomi_chopin
              DEFAULT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
              echo "成功克隆默认分支: $DEFAULT_BRANCH"
              cd ..
              exit 0
            fi
            sleep 5
          done
          
          echo "❌ 所有克隆尝试均失败，请检查仓库地址"
          exit 1

      # ===== 修正后的依赖安装（已移除 g++-multilib）=====
      - name: 安装依赖包
        run: |
          sudo apt update
          sudo apt install -y git ccache automake flex lzop bison \
            gperf build-essential zip curl zlib1g-dev zlib1g-dev:native \
            python3 python3-pip libxml2-utils bzip2 libbz2-dev \
            libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush \
            schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev \
            pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl \
            libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev \
            libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      # ===== 改进的 Clang 下载（多版本备选 + 后备源）=====
      - name: 下载 Clang
        run: |
          mkdir -p clang
          cd clang
          # 尝试多个可能的 Clang 版本（按可靠性排序）
          VERSIONS=("clang-r416183b" "clang-r450784e" "clang-r487747c" "clang-r498229b")
          SUCCESS=false
          for VER in "${VERSIONS[@]}"; do
            URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/${VER}.tar.gz"
            echo "尝试下载 $URL ..."
            # 先检查 URL 是否存在（不下载）
            if wget --spider --timeout=10 "$URL" 2>/dev/null; then
              echo "URL 有效，正在下载 ${VER}..."
              if wget --timeout=30 -O clang.tar.gz "$URL" && tar -xzf clang.tar.gz; then
                SUCCESS=true
                break
              fi
            else
              echo "$VER 不可用，尝试下一个..."
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "所有 AOSP 源均失败，尝试从 ZyCromerZ 的 GitHub 仓库下载..."
            # 使用 ZyCromerZ 预构建的 Clang（版本 19.0.0git，基于 LLVM 19）
            GH_URL="https://github.com/ZyCromerZ/Clang/releases/download/19.0.0git-20241113/Clang-19.0.0git-20241113.tar.gz"
            wget --timeout=30 -O clang.tar.gz "$GH_URL" && tar -xzf clang.tar.gz && SUCCESS=true
          fi
          
          if [ "$SUCCESS" = false ]; then
            echo "❌ 所有 Clang 下载源均失败"
            exit 1
          fi
          
          echo "Clang 下载并解压成功，bin 目录：$(pwd)/bin"
          echo "$(pwd)/bin" >> $GITHUB_PATH
        working-directory: ${{ runner.temp }}

      # 下载 GCC 工具链（保持不变）
      - name: 下载 GCC 工具链
        run: |
          git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b master --depth 1
          echo "$(pwd)/aarch64-linux-android-4.9/bin" >> $GITHUB_PATH
        working-directory: ${{ runner.temp }}

      # rKSU 集成
      - name: 克隆 rKSU 仓库并检出指定 commit
        run: |
          git clone https://github.com/rsuntk/KernelSU.git rksu_src
          cd rksu_src
          git checkout ${{ github.event.inputs.rksu_commit }}
          echo "已检出 commit: $(git rev-parse HEAD)"
        working-directory: ${{ runner.temp }}

      - name: 手动集成 rKSU 驱动到内核源码
        run: |
          cd kernel_xiaomi_chopin
          mkdir -p KernelSU
          cp -r ${{ runner.temp }}/rksu_src/kernel/* KernelSU/
          
          if ! grep -q "source \"KernelSU/Kconfig\"" Kconfig; then
            echo "" >> Kconfig
            echo "source \"KernelSU/Kconfig\"" >> Kconfig
          fi
          
          if ! grep -q "obj-y += KernelSU/" Makefile; then
            echo "" >> Makefile
            echo "obj-y += KernelSU/" >> Makefile
          fi
          
          echo "rKSU 驱动已集成 (commit: ${{ github.event.inputs.rksu_commit }})"

      # SUSFS 集成（可选）
      - name: 集成 SUSFS 4.14 补丁
        if: ${{ github.event.inputs.enable_susfs == 'true' }}
        run: |
          cd kernel_xiaomi_chopin
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.14
          
          cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
          cp susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch ./
          cp -r susfs4ksu/kernel_patches/fs/* fs/
          cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/
          
          cd KernelSU && patch -p1 < 10_enable_susfs_for_ksu.patch
          cd .. && patch -p1 < 50_add_susfs_in_kernel-4.14.patch
          
          echo "SUSFS 补丁应用完成"

      # 内核配置
      - name: 配置内核
        run: |
          cd kernel_xiaomi_chopin
          # 重要：请根据你的内核修改 defconfig 文件名
          make ARCH=arm64 chopin_defconfig || echo "警告：使用默认配置，若失败请手动指定正确的 defconfig"

          scripts/config --enable CONFIG_KSU_MANUAL_HOOK
          scripts/config --disable CONFIG_KSU_SYSCALL_HOOK
          scripts/config --enable CONFIG_KSU_MULTI_MANAGER_SUPPORT

          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            scripts/config --enable CONFIG_KSU_SUSFS
            scripts/config --enable CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_SU
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_KSTAT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_BINDER
          fi

          make savedefconfig
          cp defconfig arch/arm64/configs/custom_defconfig

      # 编译内核
      - name: 编译内核
        run: |
          cd kernel_xiaomi_chopin
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-android-
          export CC=clang
          export CLANG_TRIPLE=aarch64-linux-gnu-

          make -j$(nproc) O=out ARCH=arm64 CC=clang LD=ld.lld 2>&1 | tee build.log

          if [ -f out/arch/arm64/boot/Image.gz-dtb ]; then
            cp out/arch/arm64/boot/Image.gz-dtb ../Image.gz-dtb
          elif [ -f out/arch/arm64/boot/Image.gz ]; then
            cp out/arch/arm64/boot/Image.gz ../Image.gz
          else
            echo "未找到内核镜像文件"
            exit 1
          fi

      # 打包 AnyKernel3
      - name: 准备 AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git -b master AnyKernel3
        working-directory: ${{ runner.temp }}

      - name: 创建刷机包
        run: |
          cp Image.gz-dtb ${{ runner.temp }}/AnyKernel3/ 2>/dev/null || cp Image.gz ${{ runner.temp }}/AnyKernel3/
          
          cd ${{ runner.temp }}/AnyKernel3
          echo "Kernel with rKSU" > README
          echo "Build date: $(date)" >> README
          echo "rKSU commit: ${{ github.event.inputs.rksu_commit }}" >> README
          echo "SUSFS: ${{ github.event.inputs.enable_susfs }}" >> README
          
          zip -r9 kernel-$(date +%Y%m%d-%H%M).zip * -x .git README.md *placeholder
          mv kernel-*.zip $GITHUB_WORKSPACE/

      - name: 上传内核刷机包
        uses: actions/upload-artifact@v4
        with:
          name: kernel-rksu-susfs
          path: ./*.zip
          if-no-files-found: error