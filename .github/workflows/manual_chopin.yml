name: Manual ReSukiSU Build (Final Success)

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: '内核源码地址'
        required: true
        default: 'https://github.com/ChopinKernels/kernel_xiaomi_chopin_android_S'
      repo_branch:
        description: '分支名 (MIUI 13/14 建议用 master)'
        required: true
        default: 'master'
      enable_kpm:
        description: '开启 KPM (KernelSU)'
        type: boolean
        default: true
      enable_susfs:
        description: '注入 SUSFS 补丁'
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境准备
        uses: actions/checkout@v4

      - name: 2. 拉取编译脚本
        uses: actions/checkout@v4
        with:
          repository: ReSukiSU/ReSukiSU
          path: resukisu_tool

      - name: 3. 执行编译与打包
        working-directory: ./resukisu_tool
        run: |
          # 确保脚本有权限运行
          chmod +x *.sh
          # 启动 ReSukiSU 主程序
          ./build.sh
        env:
          # 基础配置
          KERNEL_REPO: ${{ inputs.repo_url }}
          KERNEL_BRANCH: ${{ inputs.repo_branch }}
          KERNEL_DEVICE: chopin
          KERNEL_DEFCONFIG: chopin_defconfig
          
          # 编译器配置 (这是关键，不需要你准备NDK，脚本会自动下)
          # 使用 AOSP 官方 R487747c Clang，对 MT6893 兼容性最好
          CLANG_URL: https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz
          
          # 功能开关 (KPM & SUSFS)
          ENABLE_KERNELSU: ${{ inputs.enable_kpm }}
          ENABLE_KERNELSU_SFS: ${{ inputs.enable_susfs }}
          
          # 打包配置 (自动生成可刷入的ZIP)
          USE_ANYKERNEL3: true
          ENABLE_CCACHE: true
          
          # 自动发布到 Releases 页面
          CONFIRM_RELEASE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
