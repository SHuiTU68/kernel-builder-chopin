name: 手动构建 Chopin 内核 (rKSU + SUSFS)

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: '内核源码仓库 (格式: owner/repo，例如 ChopinKernels/kernel_xiaomi_chopin_android_S)'
        required: true
        default: 'ChopinKernels/kernel_xiaomi_chopin_android_S'
      kernel_branch:
        description: '内核源码分支或标签'
        required: true
        default: 'main'
      enable_susfs:
        description: '启用 SUSFS 功能'
        type: boolean
        default: false
      rksu_commit:
        description: 'rKSU 的 commit 哈希值 (例如 46b695633ebce2fd87d811e45e14789725ee041ecd690cb2b1a1caf962f12ed4)'
        required: true
        default: '46b695633ebce2fd87d811e45e14789725ee041ecd690cb2b1a1caf962f12ed4'

jobs:
  build-kernel:
    name: 编译内核 (rKSU + SUSFS)
    runs-on: ubuntu-22.04
    steps:
      # 1. 检出工作流仓库（用于存放 AnyKernel3）
      - name: 检出工作流仓库
        uses: actions/checkout@v4

      # 2. 格式化内核仓库地址（处理用户可能输入的完整 URL）
      - name: 格式化仓库地址
        id: format_repo
        run: |
          RAW_REPO="${{ github.event.inputs.kernel_repo }}"
          # 如果输入的是完整 HTTPS 地址，提取 owner/name 部分
          if [[ "$RAW_REPO" =~ ^https?://github.com/([^/]+/[^/]+)(\.git)?$ ]]; then
            CLEAN_REPO="${BASH_REMATCH[1]}"
          elif [[ "$RAW_REPO" =~ ^[^/]+/[^/]+$ ]]; then
            CLEAN_REPO="$RAW_REPO"
          else
            echo "❌ 无法识别的仓库格式: $RAW_REPO"
            exit 1
          fi
          echo "clean_repo=$CLEAN_REPO" >> $GITHUB_OUTPUT
          echo "使用仓库: $CLEAN_REPO"

      # 3. 检出内核源码（使用格式化后的仓库名）
      - name: 检出内核源码
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.format_repo.outputs.clean_repo }}
          ref: ${{ github.event.inputs.kernel_branch }}
          path: kernel_xiaomi_chopin

      # 4. 安装系统构建依赖
      - name: 安装依赖包
        run: |
          sudo apt update
          sudo apt install -y git ccache automake flex lzop bison \
            gperf build-essential zip curl zlib1g-dev zlib1g-dev:native \
            g++-multilib python3 python3-pip libxml2-utils bzip2 libbz2-dev \
            libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush \
            schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev \
            pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl \
            libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev \
            libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      # 5. 下载 Clang 工具链
      - name: 下载 Clang
        run: |
          mkdir -p clang-r450784d
          cd clang-r450784d
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r450784d.tar.gz
          tar -xzf clang-r450784d.tar.gz
          echo "$(pwd)/bin" >> $GITHUB_PATH
        working-directory: ${{ runner.temp }}

      # 6. 下载 GCC 交叉编译器
      - name: 下载 GCC 工具链
        run: |
          git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b master --depth 1
          echo "$(pwd)/aarch64-linux-android-4.9/bin" >> $GITHUB_PATH
        working-directory: ${{ runner.temp }}

      # ========== 集成 rKSU (使用指定的 commit 哈希) ==========
      - name: 克隆 rKSU 仓库并检出指定 commit
        run: |
          git clone https://github.com/rsuntk/KernelSU.git rksu_src
          cd rksu_src
          git checkout ${{ github.event.inputs.rksu_commit }}
          echo "已检出 commit: $(git rev-parse HEAD)"
        working-directory: ${{ runner.temp }}

      - name: 手动集成 rKSU 驱动到内核源码
        run: |
          cd kernel_xiaomi_chopin
          # 创建 KernelSU 目录（如果不存在）
          mkdir -p KernelSU
          # 复制驱动文件（从克隆的 rKSU 仓库的 kernel/ 目录）
          cp -r ${{ runner.temp }}/rksu_src/kernel/* KernelSU/
          
          # 在内核根目录的 Kconfig 中添加对 KernelSU 的引用（如果尚未添加）
          if ! grep -q "source \"KernelSU/Kconfig\"" Kconfig; then
            echo "" >> Kconfig
            echo "source \"KernelSU/Kconfig\"" >> Kconfig
          fi
          
          # 在内核根目录的 Makefile 中添加 KernelSU 编译项（如果尚未添加）
          if ! grep -q "obj-y += KernelSU/" Makefile; then
            echo "" >> Makefile
            echo "obj-y += KernelSU/" >> Makefile
          fi
          
          echo "rKSU 驱动已集成 (commit: ${{ github.event.inputs.rksu_commit }})"

      # ========== SUSFS 集成（可选） ==========
      - name: 集成 SUSFS 4.14 补丁
        if: ${{ github.event.inputs.enable_susfs == 'true' }}
        run: |
          cd kernel_xiaomi_chopin
          # 克隆 SUSFS 补丁仓库 (4.14 分支)
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.14
          
          # 复制补丁和文件到内核源码相应位置
          cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
          cp susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch ./
          cp -r susfs4ksu/kernel_patches/fs/* fs/
          cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/
          
          # 应用补丁
          cd KernelSU && patch -p1 < 10_enable_susfs_for_ksu.patch
          cd .. && patch -p1 < 50_add_susfs_in_kernel-4.14.patch
          
          echo "SUSFS 补丁应用完成"

      # ========== 内核配置 ==========
      - name: 配置内核
        run: |
          cd kernel_xiaomi_chopin
          # 使用设备的 defconfig（请根据实际文件名修改）
          make ARCH=arm64 chopin_defconfig

          # rKSU 配置：非 GKI 内核使用手动钩子
          scripts/config --enable CONFIG_KSU_MANUAL_HOOK
          scripts/config --disable CONFIG_KSU_SYSCALL_HOOK
          scripts/config --enable CONFIG_KSU_MULTI_MANAGER_SUPPORT

          # SUSFS 配置（如果启用）
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            scripts/config --enable CONFIG_KSU_SUSFS
            # 可选 SUSFS 特性
            scripts/config --enable CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_SU
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_KSTAT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_BINDER
          fi

          # 保存配置供参考
          make savedefconfig
          cp defconfig arch/arm64/configs/custom_defconfig

      # ========== 编译内核 ==========
      - name: 编译内核
        run: |
          cd kernel_xiaomi_chopin
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-android-
          export CC=clang
          export CLANG_TRIPLE=aarch64-linux-gnu-

          make -j$(nproc) O=out ARCH=arm64 CC=clang LD=ld.lld 2>&1 | tee build.log

          # 复制内核镜像
          if [ -f out/arch/arm64/boot/Image.gz-dtb ]; then
            cp out/arch/arm64/boot/Image.gz-dtb ../Image.gz-dtb
          elif [ -f out/arch/arm64/boot/Image.gz ]; then
            cp out/arch/arm64/boot/Image.gz ../Image.gz
          else
            echo "未找到内核镜像文件"
            exit 1
          fi

      # ========== 打包为刷机包 ==========
      - name: 准备 AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3