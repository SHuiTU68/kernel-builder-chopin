name: Manual ReSukiSU Build (Final Success)

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: '内核源码地址'
        required: true
        default: 'https://github.com/ChopinKernels/kernel_xiaomi_chopin_android_S'
      repo_branch:
        description: '分支名 (如 master)'
        required: true
        default: 'master'
      enable_kpm:
        description: '开启 KPM (KernelSU)'
        type: boolean
        default: true
      enable_susfs:
        description: '注入 SUSFS 补丁'
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境准备
        uses: actions/checkout@v4

      - name: 2. 获取编译工具 (直接放在根目录)
        run: |
          # 直接克隆 ReSukiSU 仓库的内容到当前目录
          git clone --depth=1 https://github.com/ReSukiSU/ReSukiSU.git .

      - name: 3. 执行编译与打包
        run: |
          # 确保脚本有权限
          chmod +x *.sh
          # 运行主脚本
          ./build.sh
        env:
          # 源码与分支
          KERNEL_REPO: ${{ inputs.repo_url }}
          KERNEL_BRANCH: ${{ inputs.repo_branch }}
          KERNEL_DEVICE: chopin
          KERNEL_DEFCONFIG: chopin_defconfig
          
          # 核心功能开关
          ENABLE_KERNELSU: ${{ inputs.enable_kpm }}
          ENABLE_KERNELSU_SFS: ${{ inputs.enable_susfs }}
          
          # 编译器 (由脚本自动下载，无需NDK)
          CLANG_URL: https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz
          
          # 自动化打包与发布
          USE_ANYKERNEL3: true
          ENABLE_CCACHE: true
          CONFIRM_RELEASE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
