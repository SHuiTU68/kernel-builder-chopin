name: 手动构建内核 (rKSU + SUSFS)

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: '内核源码仓库 (格式: owner/repo，例如 xiaomi-mt6893-dev/kernel_xiaomi_mt6893)'
        required: true
        default: 'xiaomi-mt6893-dev/kernel_xiaomi_mt6893'
      kernel_branch:
        description: '内核源码分支 (留空则自动使用默认分支)'
        required: false
        default: ''
      enable_susfs:
        description: '启用 SUSFS 功能'
        type: boolean
        default: false
      rksu_version:
        description: 'rKSU 版本 (commit 哈希 或 tag，例如 v3.0.0-30-legacy)'
        required: true
        default: 'v3.0.0-30-legacy'

jobs:
  build-kernel:
    name: 编译内核 (rKSU + SUSFS)
    runs-on: ubuntu-22.04
    steps:
      - name: 检出工作流仓库
        uses: actions/checkout@v4

      - name: 格式化仓库地址
        id: format_repo
        run: |
          RAW_REPO="${{ github.event.inputs.kernel_repo }}"
          if [[ "$RAW_REPO" =~ ^https?://github.com/([^/]+/[^/]+)(\.git)?$ ]]; then
            CLEAN_REPO="${BASH_REMATCH[1]}"
          elif [[ "$RAW_REPO" =~ ^[^/]+/[^/]+$ ]]; then
            CLEAN_REPO="$RAW_REPO"
          else
            echo "❌ 无法识别的仓库格式: $RAW_REPO"
            exit 1
          fi
          echo "clean_repo=$CLEAN_REPO" >> $GITHUB_OUTPUT
          echo "使用仓库: $CLEAN_REPO"

      # ===== 智能克隆内核源码 =====
      - name: 克隆内核源码（自动处理分支）
        id: clone_kernel
        run: |
          REPO="${{ steps.format_repo.outputs.clean_repo }}"
          CLONE_URL="https://github.com/${REPO}.git"
          USER_BRANCH="${{ github.event.inputs.kernel_branch }}"
          
          if [ -n "$USER_BRANCH" ]; then
            echo "尝试克隆用户指定的分支: $USER_BRANCH"
            for i in {1..3}; do
              echo "尝试 $i/3..."
              if git clone --depth=1 --branch "$USER_BRANCH" "$CLONE_URL" kernel_xiaomi_chopin; then
                echo "成功克隆分支 $USER_BRANCH"
                exit 0
              fi
              sleep 5
            done
            echo "警告：无法克隆指定分支 $USER_BRANCH，将尝试克隆默认分支"
          fi
          
          echo "尝试克隆默认分支"
          for i in {1..3}; do
            echo "尝试 $i/3..."
            if git clone --depth=1 "$CLONE_URL" kernel_xiaomi_chopin; then
              cd kernel_xiaomi_chopin
              DEFAULT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
              echo "成功克隆默认分支: $DEFAULT_BRANCH"
              cd ..
              exit 0
            fi
            sleep 5
          done
          
          echo "❌ 所有克隆尝试均失败，请检查仓库地址"
          exit 1

      # ===== 安装依赖包 =====
      - name: 安装依赖包
        run: |
          sudo apt update
          sudo apt install -y git ccache automake flex lzop bison \
            gperf build-essential zip curl zlib1g-dev zlib1g-dev:native \
            python3 python3-pip libxml2-utils bzip2 libbz2-dev \
            libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush \
            schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev \
            pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl \
            libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev \
            libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            clang-14 lld-14 llvm-14

      - name: 验证工具链
        run: |
          clang-14 --version
          aarch64-linux-gnu-gcc --version
          ld.lld-14 --version

      # ===== rKSU 集成（增强容错）=====
      - name: 克隆 rKSU 仓库并尝试检出指定版本
        id: rksu_clone
        run: |
          git clone https://github.com/rsuntk/KernelSU.git rksu_src
          cd rksu_src
          VERSION="${{ github.event.inputs.rksu_version }}"
          echo "尝试检出版本: $VERSION"
          if git rev-parse --verify "$VERSION^{commit}" >/dev/null 2>&1; then
            git checkout "$VERSION"
            echo "✅ 成功检出版本: $VERSION"
          else
            echo "⚠️ 版本 $VERSION 不存在，将使用默认分支 main"
            git checkout main
            echo "rksu_actual_version=main" >> $GITHUB_OUTPUT
          fi
          echo "实际使用的 commit: $(git rev-parse HEAD)"
        working-directory: ${{ runner.temp }}

      - name: 手动集成 rKSU 驱动到内核源码
        run: |
          cd kernel_xiaomi_chopin
          mkdir -p KernelSU
          cp -r ${{ runner.temp }}/rksu_src/kernel/* KernelSU/
          
          if ! grep -q "source \"KernelSU/Kconfig\"" Kconfig; then
            echo "" >> Kconfig
            echo "source \"KernelSU/Kconfig\"" >> Kconfig
          fi
          
          if ! grep -q "obj-y += KernelSU/" Makefile; then
            echo "" >> Makefile
            echo "obj-y += KernelSU/" >> Makefile
          fi
          
          echo "rKSU 驱动已集成"

      # ===== SUSFS 集成（可选）=====
      - name: 集成 SUSFS 4.14 补丁
        if: ${{ github.event.inputs.enable_susfs == 'true' }}
        run: |
          cd kernel_xiaomi_chopin
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.14
          
          cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
          cp susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch ./
          cp -r susfs4ksu/kernel_patches/fs/* fs/
          cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/
          
          cd KernelSU && patch -p1 < 10_enable_susfs_for_ksu.patch
          cd .. && patch -p1 < 50_add_susfs_in_kernel-4.14.patch
          
          echo "SUSFS 补丁应用完成"

      # ===== 内核配置（严格检查）=====
      - name: 配置内核
        run: |
          cd kernel_xiaomi_chopin
          # 智能查找 defconfig
          if [ -f arch/arm64/configs/chopin_defconfig ]; then
            echo "使用 arch/arm64/configs/chopin_defconfig"
            make ARCH=arm64 chopin_defconfig
          elif [ -f arch/arm64/configs/vendor/chopin_defconfig ]; then
            echo "使用 arch/arm64/configs/vendor/chopin_defconfig"
            make ARCH=arm64 vendor/chopin_defconfig
          else
            DEFCONFIG=$(find arch/arm64/configs -name "*defconfig" | head -n1)
            if [ -n "$DEFCONFIG" ]; then
              echo "使用找到的配置文件: $DEFCONFIG"
              make ARCH=arm64 $(basename $DEFCONFIG)
            else
              echo "❌ 未找到任何 defconfig，请手动指定"
              exit 1
            fi
          fi

          if [ ! -f .config ]; then
            echo "❌ defconfig 执行后未生成 .config"
            exit 1
          fi

          # rKSU 必需配置
          scripts/config --enable CONFIG_KSU_MANUAL_HOOK
          scripts/config --disable CONFIG_KSU_SYSCALL_HOOK
          scripts/config --enable CONFIG_KSU_MULTI_MANAGER_SUPPORT

          # SUSFS 配置
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            scripts/config --enable CONFIG_KSU_SUSFS
            scripts/config --enable CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_SU
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_KSTAT
            scripts/config --enable CONFIG_KSU_SUSFS_SUS_BINDER
          fi

          if [ ! -f .config ]; then
            echo "❌ 修改配置后 .config 丢失"
            exit 1
          fi

          make savedefconfig
          cp defconfig arch/arm64/configs/custom_defconfig

      # ===== 编译内核（增强镜像查找）=====
      - name: 编译内核
        run: |
          cd kernel_xiaomi_chopin
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CC=clang-14
          export LD=ld.lld-14
          make -j$(nproc) O=out ARCH=arm64 CC=clang-14 LD=ld.lld-14 LLVM=1 2>&1 | tee build.log

          # 输出编译后的 boot 目录内容供调试
          echo "=== 编译完成，检查 out/arch/arm64/boot/ 目录 ==="
          ls -la out/arch/arm64/boot/ || echo "目录不存在"
          
          # 尝试查找内核镜像文件（支持多种常见格式）
          IMAGE_FOUND=""
          BOOT_DIR="out/arch/arm64/boot"
          for img in Image.gz-dtb Image.gz Image zImage Image.bin; do
            if [ -f "$BOOT_DIR/$img" ]; then
              IMAGE_FOUND="$BOOT_DIR/$img"
              echo "找到内核镜像: $IMAGE_FOUND"
              break
            fi
          done
          
          if [ -z "$IMAGE_FOUND" ]; then
            echo "❌ 未找到内核镜像文件，编译可能失败"
            exit 1
          fi
          
          # 复制到工作目录，统一命名为 Image 以便后续打包
          cp "$IMAGE_FOUND" ../Image
          echo "内核镜像已复制为 $(pwd)/../Image"

      # ===== 打包 AnyKernel3 =====
      - name: 准备 AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git -b master AnyKernel3
        working-directory: ${{ runner.temp }}

      - name: 创建刷机包
        run: |
          if [ ! -f Image ]; then
            echo "❌ Image 文件不存在于工作目录"
            exit 1
          fi
          cp Image ${{ runner.temp }}/AnyKernel3/
          
          cd ${{ runner.temp }}/AnyKernel3
          echo "Kernel with rKSU" > README
          echo "Build date: $(date)" >> README
          echo "rKSU version: ${{ github.event.inputs.rksu_version }}" >> README
          echo "SUSFS: ${{ github.event.inputs.enable_susfs }}" >> README
          
          zip -r9 kernel-$(date +%Y%m%d-%H%M).zip * -x .git README.md *placeholder
          mv kernel-*.zip $GITHUB_WORKSPACE/

      - name: 上传内核刷机包
        uses: actions/upload-artifact@v4
        with:
          name: kernel-rksu-susfs
          path: ./*.zip
          if-no-files-found: error